<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Result</title>
<style>
	#map {
	  width: 800px;
	  height: 600px;
	  border: 1px solid #999;
	}
</style>
</head>
<body>
	<h3>検索結果</h3>
	<div th:each="searchresult : ${searchresults}" th:object="${searchresult}">
		<p>
			<span th:text="*{storeName}"></span>
			<span th:text="*{open_now} == true ? '営業中' : '営業時間外'"></span>
<!--			<span th:text="*{lat}"></span>-->
<!--			<span th:text="*{lng}"></span>-->
			<input type="hidden" th:value="*{lat}" th:name="*{lng}">
			<button class="btn">ルート検索</button> <!-- #TODO: 下で直前の要素を取得しているので変更あるとき注意 -->
		</p>
	</div>
	<div id="map"></div>
	
	<!--	#TODO: なぜかjs読み込めない-->
	<!--	<script src="initmap.js"></script>-->
	
	<script>
		var directionsRenderer;
		let nowLatLng;
		
		function initMap() {
			let map;
			
			function success(position) {
				let coords = position.coords;
				nowLatLng = new google.maps.LatLng(coords.latitude, coords.longitude);
				let mapOptions = {
					zoom: 15,
					center: nowLatLng,
					mapId: "574de86c3981bebd"
				};
				
				map = new google.maps.Map(document.getElementById('map'), mapOptions); //マップの作成
				let marker = new google.maps.marker.AdvancedMarkerElement({
					position: nowLatLng, //マーカーの位置（必須）
					map: map //マーカーを表示する地図
				});
				directionsRenderer = new google.maps.DirectionsRenderer();
				directionsRenderer.setMap(map); //レンダラにマップを関連付け
			}
			
			function fail(error) {
				alert('位置情報の取得に失敗しました。エラーコード：' + error.code);
				let latLng = new google.maps.LatLng(35.6812405, 139.7649361); //東京駅
				let mapOptions = {
					zoom: 15,
					center: latLng,
					mapId: "574de86c3981bebd"
				};
				map = new google.maps.Map(document.getElementById('map'), mapOptions);
				
				directionsRenderer = new google.maps.DirectionsRenderer();
				directionsRenderer.setMap(map); //レンダラにマップを関連付け
			}
			
			const options = {
			  enableHighAccuracy: true, //精度（trueだと良い）
			  timeout: 5000, //制限時間
			  maximumAge: 0, //キャッシュの位置情報の有効期限。期限内だと新たに取得せずキャッシュから返す
			};
			
			navigator.geolocation.getCurrentPosition(success, fail, options); //現在地が取得できればsuccessに位置情報、できなければfail関数にエラー、optionsは各種設定
			
		}
		
		document.querySelectorAll('.btn').forEach(element => element.addEventListener('click', function(){calcRoute(this)})); //ルート検索ボタンに検索関数を結び付け
		function calcRoute(obj) {
			let preSibling = obj.previousElementSibling;
			let lat = preSibling.value;
			let lng = preSibling.getAttribute('name');
			let deslatLng = new google.maps.LatLng(lat, lng); //hiddenにある目的地の経緯度を取得
			let request = {
				origin: nowLatLng, //現在地の経緯度 #TODO: 現在地が取得できなかった場合どうする
				destination: deslatLng,
				travelMode: 'WALKING'
			};
			
			new google.maps.DirectionsService().route(request, function(result, status) { //第一引数をリクエストすると返ってくるresultとstatusを第二引数の関数に渡す
				if (status === 'OK') {
					//alert(status);
					let distance = result.routes[0].legs[0].distance.text;
					let duration = result.routes[0].legs[0].duration.text;
					preSibling.insertAdjacentHTML('afterend', '<span>' + distance + '</span>');
					directionsRenderer.setDirections(result); //ルートをマップに表示
				} else {
					alert(status);
				}
			});
		}
	</script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvngfDlCJ3HuSMFjB0jylBTpowN9pb-RQ&callback=initMap&libraries=marker" async defer></script>
</body>
</html>